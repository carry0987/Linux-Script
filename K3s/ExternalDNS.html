
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta charset="UTF-8">
        <title>ExternalDNS Â· Linux-Script</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 6.0.2">
        <meta name="author" content="carry0987">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/honkit-plugin-tooltips/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/honkit-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/honkit-plugin-prism/prism-tomorrow.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/@honkit/honkit-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../Server/" />
    
    
    <link rel="prev" href="CertManager.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../Common/">
            
                <a href="../Common/">
            
                    
                    Regular Command
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../Common/CommandList.html">
            
                <a href="../Common/CommandList.html">
            
                    
                    Command List
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../Common/Sudo.html">
            
                <a href="../Common/Sudo.html">
            
                    
                    Run SUDO without password
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../Common/ChangeUsername.html">
            
                <a href="../Common/ChangeUsername.html">
            
                    
                    Change Username
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Common/ChangeNetworkInterfaceName.html">
            
                <a href="../Common/ChangeNetworkInterfaceName.html">
            
                    
                    Change Network Interface Name
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../Common/DisableCloudInit.html">
            
                <a href="../Common/DisableCloudInit.html">
            
                    
                    Disable cloud-init
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../Crontab/">
            
                <a href="../Crontab/">
            
                    
                    Crontab
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../Crontab/what_is_cron.html">
            
                <a href="../Crontab/what_is_cron.html">
            
                    
                    What is cron
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../Crontab/restrictions.html">
            
                <a href="../Crontab/restrictions.html">
            
                    
                    Crontab Restrictions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../Crontab/commands.html">
            
                <a href="../Crontab/commands.html">
            
                    
                    Crontab Commands
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../Crontab/syntax.html">
            
                <a href="../Crontab/syntax.html">
            
                    
                    Crontab Syntax
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../Crontab/example.html">
            
                <a href="../Crontab/example.html">
            
                    
                    Crontab Example
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../Crontab/environment.html">
            
                <a href="../Crontab/environment.html">
            
                    
                    Crontab Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../Crontab/log_file_and_disable_email.html">
            
                <a href="../Crontab/log_file_and_disable_email.html">
            
                    
                    Log file & Disable Email
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../Crontab/file_location.html">
            
                <a href="../Crontab/file_location.html">
            
                    
                    Crontab file location
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../Tools/">
            
                <a href="../Tools/">
            
                    
                    Tools
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../Setup/">
            
                <a href="../Setup/">
            
                    
                    Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../Vim/">
            
                <a href="../Vim/">
            
                    
                    Vim
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../Htop/">
            
                <a href="../Htop/">
            
                    
                    Htop
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <span>
            
                    
                    Docker
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../Docker/setup.html">
            
                <a href="../Docker/setup.html">
            
                    
                    Docker Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../Docker/command.html">
            
                <a href="../Docker/command.html">
            
                    
                    Docker Command
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../Docker/nginx-proxy-manager.html">
            
                <a href="../Docker/nginx-proxy-manager.html">
            
                    
                    Nginx Proxy Manager
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../Docker/portainer.html">
            
                <a href="../Docker/portainer.html">
            
                    
                    Portainer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="../Docker/n8n.html">
            
                <a href="../Docker/n8n.html">
            
                    
                    N8N
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" >
            
                <span>
            
                    
                    K3s
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="Setup.html">
            
                <a href="Setup.html">
            
                    
                    K3s Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="Uninstall.html">
            
                <a href="Uninstall.html">
            
                    
                    K3s Uninstall
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.3" data-path="CommandList.html">
            
                <a href="CommandList.html">
            
                    
                    K3s Command List
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.4" data-path="Helm.html">
            
                <a href="Helm.html">
            
                    
                    Helm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.5" data-path="MetalLB.html">
            
                <a href="MetalLB.html">
            
                    
                    MetalLB
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.6" data-path="Istio.html">
            
                <a href="Istio.html">
            
                    
                    Istio
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.7" data-path="Longhorn.html">
            
                <a href="Longhorn.html">
            
                    
                    Longhorn
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.8" data-path="Secret.html">
            
                <a href="Secret.html">
            
                    
                    Secret
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.9" data-path="CertManager.html">
            
                <a href="CertManager.html">
            
                    
                    Cert-Manager
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.9.10" data-path="ExternalDNS.html">
            
                <a href="ExternalDNS.html">
            
                    
                    ExternalDNS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../Server/">
            
                <a href="../Server/">
            
                    
                    Server
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" >
            
                <span>
            
                    
                    GCP
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.11.1" data-path="../GCP/SSH.html">
            
                <a href="../GCP/SSH.html">
            
                    
                    Connect GCP with SSH Key
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.12" >
            
                <span>
            
                    
                    Web
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.12.1" data-path="../Web/UFW.html">
            
                <a href="../Web/UFW.html">
            
                    
                    UFW
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.2" data-path="../Web/Nginx.html">
            
                <a href="../Web/Nginx.html">
            
                    
                    Nginx
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.12.3" data-path="../Web/LetsEncrypt.html">
            
                <a href="../Web/LetsEncrypt.html">
            
                    
                    Let's Encrypt
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.13" >
            
                <span>
            
                    
                    qBittorrent
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.13.1" data-path="../qBittorrent/Setup.html">
            
                <a href="../qBittorrent/Setup.html">
            
                    
                    qBittorrent Setup
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.13.2" data-path="../qBittorrent/Uninstall.html">
            
                <a href="../qBittorrent/Uninstall.html">
            
                    
                    qBittorrent Uninstall
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.14" data-path="../System/">
            
                <a href="../System/">
            
                    
                    System
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15" >
            
                <span>
            
                    
                    Proxy
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.15.1" data-path="../Proxy/SSR.html">
            
                <a href="../Proxy/SSR.html">
            
                    
                    SSR
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.15.2" data-path="../Proxy/VPN.html">
            
                <a href="../Proxy/VPN.html">
            
                    
                    VPN
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.16" data-path="../Git/">
            
                <a href="../Git/">
            
                    
                    Git
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17" >
            
                <span>
            
                    
                    Python
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.17.1" data-path="../Python/Conda.html">
            
                <a href="../Python/Conda.html">
            
                    
                    Conda
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.17.2" data-path="../Python/Jupyter.html">
            
                <a href="../Python/Jupyter.html">
            
                    
                    Jupyter
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.18" >
            
                <span>
            
                    
                    MacOS
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.18.1" data-path="../MacOS/zshrc.html">
            
                <a href="../MacOS/zshrc.html">
            
                    
                    zshrc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18.2" data-path="../MacOS/screenrc.html">
            
                <a href="../MacOS/screenrc.html">
            
                    
                    screenrc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18.3" data-path="../MacOS/tftp.html">
            
                <a href="../MacOS/tftp.html">
            
                    
                    tftp
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.18.4" data-path="../MacOS/Config.html">
            
                <a href="../MacOS/Config.html">
            
                    
                    Config
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            Published with HonKit
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >ExternalDNS</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <html><head></head><body><h2 id="externaldns">ExternalDNS</h2>
<h3 id="install-externaldns">Install ExternalDNS</h3>
<p>To integrate ExternalDNS with your K3s cluster using Cloudflare, follow these steps:</p>
<ol>
<li><p><strong>Create Kubernetes Secret for Cloudflare API Token:</strong></p>
<p> You'll need a Cloudflare API token with the necessary permissions (Zone:Read, DNS:Edit). Replace <code>YOUR_API_TOKEN</code> with your Cloudflare API token.</p>
<pre class="language-"><code class="lang-bash"> kubectl create secret generic cloudflare-api-key --from-literal<span class="token operator">=</span>apiKey<span class="token operator">=</span>YOUR_API_TOKEN <span class="token parameter variable">-n</span> kube-system
</code></pre>
</li>
<li><p><strong>Create values.yml for Helm Configuration:</strong></p>
<p> Create a <code>values.yml</code> file to configure ExternalDNS with Cloudflare as the DNS provider:</p>
<pre class="language-"><code class="lang-yaml"> <span class="token key atrule">provider</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> cloudflare
 <span class="token key atrule">env</span><span class="token punctuation">:</span>
   <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CF_API_TOKEN
   <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
     <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
     <span class="token key atrule">name</span><span class="token punctuation">:</span> cloudflare<span class="token punctuation">-</span>api<span class="token punctuation">-</span>key
     <span class="token key atrule">key</span><span class="token punctuation">:</span> apiKey
</code></pre>
</li>
<li><p><strong>Add and Install ExternalDNS with Helm:</strong></p>
<p> Add the ExternalDNS Helm repository and update it:</p>
<pre class="language-"><code class="lang-bash"> helm repo <span class="token function">add</span> external-dns https://kubernetes-sigs.github.io/external-dns/
 helm repo update
</code></pre>
<p> Now, install ExternalDNS in the <code>kube-system</code> namespace:</p>
<pre class="language-"><code class="lang-bash"> helm upgrade <span class="token parameter variable">--install</span> external-dns external-dns/external-dns <span class="token parameter variable">--namespace</span> kube-system <span class="token parameter variable">--values</span> values.yml
</code></pre>
</li>
</ol>
<h3 id="verify-installation">Verify Installation</h3>
<ol>
<li><p><strong>Check ExternalDNS Pods:</strong></p>
<p> Ensure the ExternalDNS pods are running by executing:</p>
<pre class="language-"><code class="lang-bash"> kubectl get pods <span class="token parameter variable">-n</span> kube-system <span class="token operator">|</span> <span class="token function">grep</span> external-dns
</code></pre>
</li>
<li><p><strong>Configure a Service with DNS Annotations:</strong></p>
<p> To test ExternalDNS, deploy a service annotated with the desired hostname. Example for an Nginx service:</p>
<pre class="language-"><code class="lang-yaml"> <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
       <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
   <span class="token key atrule">template</span><span class="token punctuation">:</span>
     <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
       <span class="token key atrule">labels</span><span class="token punctuation">:</span>
         <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
     <span class="token key atrule">spec</span><span class="token punctuation">:</span>
       <span class="token key atrule">containers</span><span class="token punctuation">:</span>
       <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
         <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
         <span class="token key atrule">ports</span><span class="token punctuation">:</span>
         <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
 <span class="token punctuation">---</span>
 <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
 <span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
 <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
   <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
   <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
     <span class="token key atrule">external-dns.alpha.kubernetes.io/hostname</span><span class="token punctuation">:</span> example.com
     <span class="token key atrule">external-dns.alpha.kubernetes.io/ttl</span><span class="token punctuation">:</span> <span class="token string">"120"</span> <span class="token comment">#optional</span>
     <span class="token key atrule">external-dns.alpha.kubernetes.io/target</span><span class="token punctuation">:</span> <span class="token string">"YOUR_PUBLIC_IP"</span> <span class="token comment">#optional</span>
     <span class="token key atrule">external-dns.alpha.kubernetes.io/cloudflare-proxied</span><span class="token punctuation">:</span> <span class="token string">"true"</span> <span class="token comment">#optional</span>
 <span class="token key atrule">spec</span><span class="token punctuation">:</span>
   <span class="token key atrule">selector</span><span class="token punctuation">:</span>
     <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
   <span class="token key atrule">type</span><span class="token punctuation">:</span> LoadBalancer
   <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
       <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
       <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre>
<p> Apply the configuration and check for the assigned <code>EXTERNAL-IP</code>:</p>
<pre class="language-"><code class="lang-bash"> kubectl apply <span class="token parameter variable">-f</span> nginx-service.yml
 kubectl get services
</code></pre>
</li>
</ol>
<h3 id="networking-notes">Networking Notes</h3>
<ul>
<li><strong>Cloudflare Configuration:</strong>
Ensure the DNS zone in Cloudflare is correctly set up and the API token has the necessary permissions.</li>
<li><strong>IP Address Consideration:</strong>
If using MetalLB, ensure the <code>EXTERNAL-IP</code> assigned by MetalLB to a service does not conflict with other network devices.</li>
</ul>
<h3 id="enable-logging">Enable Logging</h3>
<p>To troubleshoot any issues with ExternalDNS, enable logging by observing the ExternalDNS pod logs:</p>
<pre class="language-"><code class="lang-bash">kubectl logs deployment/external-dns <span class="token parameter variable">-n</span> kube-system
</code></pre>
<p>This setup allows ExternalDNS to dynamically manage DNS records for services exposed via a LoadBalancer in your K3s environment, aligning with a Cloudflare configuration for easy DNS management.</p>
<h3 id="key-considerations-and-common-issues">Key Considerations and Common Issues</h3>
<ol>
<li><p><strong>Service Type Matters:</strong></p>
<ul>
<li><p><strong>LoadBalancer</strong>: ExternalDNS typically requires services to have the type <code>LoadBalancer</code>. This is because a LoadBalancer assigns an external IP that ExternalDNS can use to update DNS records. In a cloud environment, this usually results in a publicly accessible IP.</p>
</li>
<li><p><strong>NodePort</strong>: If your environment does not support LoadBalancer and you are using <code>NodePort</code>, ensure you manually associate the Node's external IP with the DNS name in Cloudflare. This requires that you know the external IPs of the nodes and appropriately handle traffic routing.</p>
</li>
</ul>
</li>
<li><p><strong>IP Address Visibility:</strong></p>
<ul>
<li>A service of type <code>LoadBalancer</code> or <code>NodePort</code> needs to expose a public or routable IP for ExternalDNS to work effectively. In environments like MetalLB, ensure the IP range used does not conflict with local network devices.</li>
</ul>
</li>
<li><p><strong>MetalLB and Internal IP Issues:</strong></p>
<ul>
<li><p>When using MetalLB, services configured as <code>LoadBalancer</code> can end up with internal IPs (e.g., <code>192.168.x.x</code>). While useful for local testing, these are not suitable for global DNS exposure.</p>
</li>
<li><p>To expose services externally with MetalLB, consider setting up a NAT or reverse proxy for external access, and then manually adjust DNS entries or use a different cloud provider or infrastructure that provides public IPs natively.</p>
</li>
</ul>
</li>
<li><p><strong>DNS Annotations:</strong></p>
<ul>
<li><p>Ensure that services meant to be exposed via ExternalDNS have the correct DNS annotations, such as:</p>
<pre class="language-"><code class="lang-yaml">  <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
      <span class="token key atrule">external-dns.alpha.kubernetes.io/hostname</span><span class="token punctuation">:</span> <span class="token string">"your.domain.com"</span>
</code></pre>
</li>
</ul>
</li>
<li><p><strong>Cloudflare Configuration:</strong></p>
<ul>
<li>Ensure the Cloudflare API token has the proper permissions and the domain configured in your annotations matches the zones managed in Cloudflare.</li>
</ul>
</li>
</ol>
<h3 id="verification-steps">Verification Steps</h3>
<ul>
<li><p><strong>Pod and Service Status:</strong></p>
<p>  Before assuming ExternalDNS configuration issues, verify that all involved Kubernetes resources, such as Deployments, Services, and the ExternalDNS deployment itself, are running and correctly configured.</p>
<pre class="language-"><code class="lang-bash">  kubectl get pods <span class="token parameter variable">-n</span> kube-system <span class="token operator">|</span> <span class="token function">grep</span> external-dns
  kubectl get services
</code></pre>
</li>
<li><p><strong>Logs and Debugging:</strong></p>
<p>  Check logs for ExternalDNS for insight into any DNS updates or errors:</p>
<pre class="language-"><code class="lang-bash">  kubectl logs deployment/external-dns <span class="token parameter variable">-n</span> kube-system
</code></pre>
</li>
<li><p><strong>Cloudflare Dashboard:</strong></p>
<p>Confirm that DNS records are updated in Cloudflare by checking the domain's DNS settings. Ensure the ExternalDNS service has updated these records corresponding to the correct IP addresses exposed by your services.</p>
</li>
</ul>
<p>Setting ExternalDNS correctly, especially with the combination of MetalLB and internal K3s environments, demands careful handling of network configurations and service types. For production-grade setups, ensure robust IP management and DNS adjustments that reflect real-world accessibility needs.</p>
<h3 id="bgp-vs-nat-best-practices-in-different-network-scenarios">BGP vs. NAT: Best Practices in Different Network Scenarios</h3>
<p>In on-prem or private data center environments, if you want services within a K8s cluster to have "true" public IPs, there are generally two approaches:</p>
<ol>
<li><p><strong>NAT / Forwarding (Single IP / Few IPs)</strong></p>
<ul>
<li><strong>Applicable Scenarios</strong>: You have one or a few public IPs, the ISP has not provided you with an announcable IP block, or the equipment (such as FortiGate) has not enabled BGP.</li>
<li><strong>Approach</strong>: Use DNAT / Port Forwarding on the firewall or router (e.g., FortiGate) to forward external 80/443 traffic to the cluster's MetalLB IP or NodePort.</li>
<li><strong>ExternalDNS Configuration</strong>: You need to manually point the annotation to the public IP (external firewall IP). Otherwise, ExternalDNS might automatically read a private IP.</li>
<li><strong>Pros and Cons</strong>:<ul>
<li>Pros: Simple deployment, no need for ISP cooperation, or BGP environment.</li>
<li>Cons: If multiple services share the same IP, multiple Port Forwards are needed on FortiGate or use the same IP protocol to achieve multiple virtual hosts.</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>BGP Exchange (Multiple / Announcable IP Block)</strong></p>
<ul>
<li><strong>Applicable Scenarios</strong>: You have multiple public IPs (e.g., /29, /28 blocks) and can perform BGP Peering with the ISP or upstream equipment, with an ASN or route announcement permission.</li>
<li><strong>Approach</strong>: Install MetalLB and enable BGP mode, letting MetalLB be the BGP Speaker to announce the public IP assigned to a service directly to the router or upstream network.</li>
<li><strong>ExternalDNS Configuration</strong>: ExternalDNS can automatically write the public IP assigned by MetalLB into DNS. No manual override needed.</li>
<li><strong>Pros and Cons</strong>:<ul>
<li>Pros: Each service gets a truly independent public IP without NAT; a cleaner traffic path; scalable expansion.</li>
<li>Cons: Requires network equipment to support BGP and ownership of announcable IP blocks; configuration and maintenance are relatively complex.</li>
</ul>
</li>
</ul>
</li>
</ol>
<blockquote>
<p><strong>Conclusion</strong>:</p>
<ul>
<li>If you only have one public IP, or cannot use BGP, <strong>NAT</strong> with ExternalDNS manual override or Ingress/Gateway with internal IPs are common practices.</li>
<li>If you have sufficient public IP blocks and network equipment/ISP supports BGP, then <strong>BGP</strong> is a more "standard" and efficient approach, avoiding cumbersome manual NAT and DNS overrides.</li>
</ul>
</blockquote>
<hr></hr>
<p>After setting up ExternalDNS correctly, especially when combined with MetalLB in on-prem environments, it's crucial to check external IPs, DNS records, and firewall / route forwarding. Using BGP on ISP or enterprise networks allows each service to obtain a real public IP; otherwise, in a single IP + NAT environment, manual annotations can direct ExternalDNS to the firewall's external IP, with the firewall forwarding the traffic. These adjustments must be tailored to actual network conditions.</p>
</body></html>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="CertManager.html" class="navigation navigation-prev " aria-label="Previous page: Cert-Manager">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../Server/" class="navigation navigation-next " aria-label="Next page: Server">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"ExternalDNS","level":"1.9.10","depth":2,"next":{"title":"Server","level":"1.10","depth":1,"path":"Server/README.md","ref":"./Server/README.md","articles":[]},"previous":{"title":"Cert-Manager","level":"1.9.9","depth":2,"path":"K3s/CertManager.md","ref":"./K3s/CertManager.md","articles":[]},"dir":"ltr"},"config":{"plugins":["octocat","tooltips","-lunr","-search","-sharing","-page-toc-button","search-plus","-anchor-navigation-ex","-flexible-alerts","-code","prism","-highlight","-tbfed-pagefooter","-hide-element"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright &copy carry0987","modify_label":"Last Modified : ","modify_format":"YYYY-MM-DD HH:mm:ss"},"prism":{"css":["prismjs/themes/prism-tomorrow.css"],"lang":{"flow":"typescript"},"ignore":["eval-js"]},"octocat":{"url":"https://github.com/carry0987/Linux-Script"},"code":{"copyButtons":true},"tooltips":{},"hide-element":{"elements":[".gitbook-link"]},"fontsettings":{"theme":"white","family":"sans","size":2},"fontSettings":{"theme":"night","family":"sans"},"anchor-navigation-ex":{"showLevel":false,"associatedWithSummary":true,"printLog":false,"multipleH1":false,"mode":"float","showGoTop":true,"float":{"floatIcon":"fa fa-navicon","showLevelIcon":false,"level1Icon":"fa fa-hand-o-right","level2Icon":"fa fa-hand-o-right","level3Icon":"fa fa-hand-o-right"},"pageTop":{"showLevelIcon":false,"level1Icon":"fa fa-hand-o-right","level2Icon":"fa fa-hand-o-right","level3Icon":"fa fa-hand-o-right"}},"flexible-alerts":{"style":"flat"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"search-plus":{}},"theme":"default","author":"carry0987","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Linux-Script","language":"en","gitbook":"*","defaultDescription":"Store Linux Script","description":"Store Linux Script"},"file":{"path":"K3s/ExternalDNS.md","mtime":"2025-02-05T08:08:12.145Z","type":"markdown"},"gitbook":{"version":"6.0.2","time":"2025-02-05T08:08:17.723Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-octocat/plugin.js"></script>
        
    
        
        <script src="../gitbook/honkit-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/honkit-plugin-search-plus/search.js"></script>
        
    
        
        <script src="../gitbook/@honkit/honkit-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

